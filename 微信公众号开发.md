# 微信公众号开发(订阅号subscription)

[toc]

## 一	公众号	测试号开发

### -1	规划:

#### 1.普通开发

#### 2.Python开发

#### 3.Django开发

#### 4.自动化开发





### 0	整体流程概述

> 1.webstorm编写node框架的开发者服务器,并启用
>
> 2.开启ngrok服务,内网穿透,ngrok http host,指定开发者服务器端口号
>
> 3.开发者服务器编写有效性验证模块,交互,微信开放平台,注册测试号,填写相关内容申请
>
> 4.申请access_token,

> 提供业务服务于用户管理能力的服务平台

> 种类:订阅号(1次消息/天);服务号(4次消息/月);小程序;企业微信

> 普通用户,使用测试号接口权限开发

> 基本交互流程: 用户客户端 <--> 微信服务器 <-->开发者服务器

> 测试接口需要填写域名的时候,使用ngrok生成
>
> ngrok 服务可以分配给你一个域名让你本地的web项目提供给外网访问，特别适合向别人展示你本机的web demo 以及调试一些远程的API (比如微信公众号，企业号的开发) ngrok的官方服务可以在 [这里查看](https://ngrok.com/) 由于一些原因 有些同学可能打不开官方网站，国内访问不了，万幸的是ngrok 1.7版本的代码是开源的。本屌恰好有一个未到期的云服务器，且有一个闲置的已备案域名。 本着独乐乐不如众乐乐的精神，本屌不辞劳苦搭建了个ngrok的服务（小米球ngrok），来造福开发者。

| 序号 | 英文         | 中文                 | 备注             |
| ---- | ------------ | -------------------- | ---------------- |
| 1    | signature    | 微信加密签名         | req.query        |
| 2    | echostr      | 微信的随机字符串     | 返回给微信服务器 |
| 3    | timestamp    | 时间戳               |                  |
| 4    | nonce        | 微信的随机数字       |                  |
| 5    | appDI        | 测试号ID             |                  |
| 6    | appsecret    | 测试号密码           |                  |
| 7    | token        | 令牌                 |                  |
| 8    | access_token | 全局唯一接口调用凭据 |                  |
| 9    | exprie       | 失效                 | exprie_in        |
| 10   | credential   | 凭证                 |                  |
| 11   | grant        | 授权                 |                  |
|      |              |                      |                  |
|      |              |                      |                  |
|      |              |                      |                  |
|      |              |                      |                  |
|      |              |                      |                  |
|      |              |                      |                  |
|      |              |                      |                  |
|      |              |                      |                  |
|      |              |                      |                  |
|      |              |                      |                  |
|      |              |                      |                  |
|      |              |                      |                  |



### 1.申请测试接口

![image-20211213121424917](C:\Users\72985\AppData\Roaming\Typora\typora-user-images\image-20211213121424917.png)



#### 1.URL

>  使用ngrok生成本机代理
>
> 登录官网,注册用户,添加token,启动服务器 ngrok http 3000
>
> ![image-20211213121610284](C:\Users\72985\AppData\Roaming\Typora\typora-user-images\image-20211213121610284.png)

#### 2.Token 

> 自己定义

#### 3.写express服务器

```js
//1.引入express模块
const express = require('express');
//引入sha1模块
const sha1 = require('sha1');

//2.创建app应用对象
const app = express();

//3.验证服务器的有效性
//3.1 微信服务器要知道开发者服务器是哪个
//    URL:在测试号管理页面上填写URL开发者服务器地址,使用ngrok内网穿透,将本地端口开启的服务映射为外网可以访问的网址
//    指令 ngrok http 3000;
//    Token:自己填写
// 3.2 开发者服务器 验证消息是否来自微信服务器
      //目的:计算得出signature和微信传递过来的signature进行对比,如果一样说明来自微信服务器;
      // 算法: 1.将参与微信加密签名的三个参数(timestamp,noce,token),组合在一起,按照字典排序,并组合在一起,形成数组,将数组拼接成一个字符串)
      //      2.将数组进行sha1加密(npm i sha1)
      //      3.加密完生成signature ,和微信发来的一样就是验证成功
      //        3.1 如果一样,返回echostr给微信服务器
      //        3.2 如果不一样,返回error给微信服务器

//定义配置文件
const config = {
    token:'13696812048',
    appID :'wxbbb63c35cff0a39a',
    appsecret:'8930f0e111b0677d21a021e0043adb9a',

}


app.use((req,res,next)=>{
  //app.use() 可以接受处理所有消息
    console.log(req.query);
    // {
    //     signature  微信加密签名:     '000f1cd7ba43ff131842ed2322799797811462ad',
    //     echostr    微信的随机字符串:  '1261338858893081587',
    //     timestamp  时间戳:          '1639369585',
    //     nonce      微信的随机数字:    '243436994'
    // }
    //1.将参与微信加密签名的三个参数(timestamp,noce,token),组合在一起,按照字典排序,并组合在一起,形成数组,将数组拼接成一个字符串)
    //对象解构赋值,获取相应的数据
    const {signature,echostr,timestamp,nonce} = req.query;
    const {token} = config;
    const arr = [timestamp,nonce,token];
    const arrSort = arr.sort();
    const str = arr.join('');
    //2.将数组进行sha1加密(npm i sha1)
    const sha1Str = sha1(str);
    console.log(typeof(sha1Str),typeof(signature),echostr);
    //3.加密完生成signature ,和微信发来的一样就是验证成功
    console.log(req.method)
    if (sha1Str == signature) {
        console.log('ok')
        res.setHeader('Content-type','text/html;charset=utf-8');
        //res.setHeader('Content-type','application/x-www-form-urlencoded; charset=UTF-8');
        res.send(echostr);

        //lDYD9uxVyUxUgXBOu7ISmmPB6JjKlZupASdbXKiocOR
    } else {
        //res.setHeader('Content-type','text/html;charset=utf-8');
        res.send('error');
    }
});

//4.监听端口号
app.listen(3000,() => console.log('服务器启动成功了!'));
```

开启开发者服务器

![image-20211214081524498](C:\Users\72985\AppData\Roaming\Typora\typora-user-images\image-20211214081524498.png)

#### 4.验证成功

![image-20211213203717401](C:\Users\72985\AppData\Roaming\Typora\typora-user-images\image-20211213203717401.png)

### 2	获取access token

## 二	公众号 	正式号开发

